<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kobayashi Maru Simulation</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --accent: #35d07f;
  --accent-soft: #35d07f33;
  --text: #dfffea;
}
* { box-sizing: border-box; }
html, body {
  margin: 0;
  height: 100%;
  overflow: hidden;
  background: #000;
  font-family: 'Roboto Mono', monospace;
  color: var(--text);
}
#stars {
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at 50% 50%, #001 0%, #000 70%);
  overflow: hidden;
}
.star {
  position: absolute;
  width: 2px;
  height: 2px;
  background: #fff;
  border-radius: 50%;
  opacity: .85;
  animation: moveStars 6s linear infinite;
}
@keyframes moveStars {
  0% { transform: translateZ(0) scale(1); }
  100% { transform: translateZ(300px) scale(0); }
}
#hud {
  position: relative;
  z-index: 10;
  width: 92%;
  max-width: 980px;
  margin: 5% auto;
  background: linear-gradient(135deg, #0a0f12, #000);
  border: 3px solid var(--accent);
  border-radius: 22px;
  box-shadow: 0 0 40px var(--accent-soft), inset 0 0 40px #000;
  padding: 24px 28px;
  display: flex;
  flex-direction: row;
  gap: 30px;
}
#main-panel { flex: 3; display: flex; flex-direction: column; align-items: center; }
#side-panels { flex: 1; display: flex; flex-direction: column; gap: 24px; align-items: center; justify-content: flex-start; }
#header {
  font-family: 'Orbitron', sans-serif;
  font-size: 1.2rem;
  color: var(--accent);
  border-bottom: 2px solid var(--accent);
  padding-bottom: 10px;
  margin-bottom: 18px;
  text-align: center;
  letter-spacing: 1px;
}
#message {
  min-height: 150px;
  font-size: 1.06rem;
  line-height: 1.65;
  color: var(--text);
  text-shadow: 0 0 10px var(--accent-soft);
  margin-bottom: 18px;
}
#buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 14px; }
button {
  background: linear-gradient(90deg, var(--accent-soft), transparent);
  border: 1px solid var(--accent);
  color: var(--text);
  padding: 10px 22px;
  border-radius: 10px;
  font-family: 'Orbitron', sans-serif;
  font-size: 1rem;
  cursor: pointer;
  transition: .2s ease;
  letter-spacing: .5px;
  text-shadow: 0 0 10px var(--accent-soft);
}
button:hover {
  background: var(--accent);
  color: #000;
  box-shadow: 0 0 22px var(--accent);
  transform: scale(1.06);
}
.alert-green { --accent: #35d07f; --accent-soft: #35d07f55; --text: #dfffea; }
.alert-yellow { --accent: #ffd166; --accent-soft: #ffd16655; --text: #fff6db; }
.alert-red { --accent: #ff4b4b; --accent-soft: #ff4b4b55; --text: #ffe5e5; }
#alert-controls, #ship-systems {
  border: 2px solid var(--accent);
  border-radius: 12px;
  padding: 12px;
  width: 100%;
  text-align: center;
}
#alert-controls h3, #ship-systems h3 {
  font-family: 'Orbitron', sans-serif;
  font-size: 1rem;
  margin-bottom: 10px;
  color: var(--accent);
}
.alert-btn {
  display: block;
  width: 100%;
  margin: 6px 0;
  border-radius: 8px;
  font-weight: bold;
  text-transform: uppercase;
  color: #000;
  border: none;
  padding: 8px;
  font-family: 'Orbitron', sans-serif;
  letter-spacing: 0.5px;
}
.green { background-color: #35d07f; }
.yellow { background-color: #ffd166; }
.red { background-color: #ff4b4b; }
#ship-systems button {
  display: block;
  width: 100%;
  margin: 6px 0;
  border-radius: 8px;
  font-family: 'Orbitron', sans-serif;
  padding: 8px;
}
#tactical {
  position: relative;
  width: 160px;
  height: 160px;
  border: 2px solid var(--accent);
  border-radius: 50%;
  overflow: hidden;
  margin-top: 30px;
}
#sweep {
  position: absolute;
  width: 50%;
  height: 2px;
  top: 50%;
  left: 50%;
  transform-origin: left center;
  background: var(--accent);
  animation: sweep 4s linear infinite;
}
@keyframes sweep { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
.blip { position: absolute; width: 6px; height: 6px; background: var(--accent); border-radius: 50%; opacity: 0; transition: all 6s linear; }
#graduation {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: #000;
  z-index: 1000;
  padding: 40px 20px;
}
.certificate {
  position: relative;
  width: min(1100px, 92vw);
  background: #000;
  border: 3px solid #ffd47a;
  border-radius: 20px;
  box-shadow: 0 0 40px rgba(255,212,122,.35), 0 0 60px rgba(74,176,255,.25) inset;
  overflow: hidden;
}
.cert-inner {
  padding: 48px 56px;
  color: #fff;
  text-align: center;
  font-family: 'Orbitron', sans-serif;
}
.cert-title {
  font-size: 28px;
  letter-spacing: 2px;
  color: #ffd47a;
  text-transform: uppercase;
}
.cert-subtitle {
  margin-top: 6px;
  font-size: 18px;
  color: #4ab0ff;
  letter-spacing: 1px;
}
.cert-name {
  margin-top: 28px;
  font-size: 40px;
  letter-spacing: 1px;
  color: #ffffff;
}
.cert-line {
  width: 260px;
  height: 3px;
  background: linear-gradient(90deg, #ffd47a, #4ab0ff);
  border-radius: 2px;
  margin: 16px auto 0;
  box-shadow: 0 0 16px rgba(74,176,255,.35);
}
.cert-text {
  margin: 26px auto 6px;
  max-width: 820px;
  font-family: 'Roboto Mono', monospace;
  font-size: 16px;
  line-height: 1.7;
  color: #eaeaea;
}
.cert-assign {
  margin-top: 10px;
  font-family: 'Roboto Mono', monospace;
  font-size: 15px;
  color: #ffd47a;
}
.cert-sigs {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 18px;
  max-width: 820px;
  margin: 34px auto 0;
}
.sig {
  padding-top: 10px;
  border-top: 2px solid #ffd47a;
}
.sig-name {
  font-family: 'Brush Script MT', cursive;
  font-size: 28px;
  color: #ffd47a;
}
.sig-title {
  margin-top: -4px;
  font-size: 12px;
  color: #9ccfff;
  letter-spacing: .5px;
}
.cert-buttons {
  margin: 34px auto 10px;
  display: flex;
  gap: 14px;
  justify-content: center;
}
.cert-buttons button {
  background: linear-gradient(180deg, #003366, #001933);
  border: 2px solid #ffd47a;
  color: #ffd47a;
  padding: 10px 18px;
  border-radius: 10px;
  font-family: 'Orbitron', sans-serif;
  font-size: 14px;
  cursor: pointer;
  transition: transform .2s, box-shadow .2s;
}
.cert-buttons button:hover {
  transform: translateY(-2px);
  box-shadow: 0 0 16px rgba(255,212,122,.35);
}
</style>
</head>
<body class="alert-green">
<div id="stars"></div>
<div id="hud">
  <div id="main-panel">
    <div id="header">KOBAYASHI MARU — STARFLEET SIMULATION</div>
    <div id="message">Initializing simulation...</div>
    <div id="buttons"></div>
    <div id="tactical"><div id="sweep"></div></div>
  </div>
  <div id="side-panels">
    <div id="alert-controls">
      <h3>Alert Controls</h3>
      <button class="alert-btn green" onclick="setAlert('green')">Green Alert</button>
      <button class="alert-btn yellow" onclick="setAlert('yellow')">Yellow Alert</button>
      <button class="alert-btn red" onclick="setAlert('red')">Red Alert</button>
    </div>
    <div id="ship-systems">
      <h3>Ship Systems</h3>
      <button onclick="systemAction('Shields raised to full.')">Raise Shields</button>
      <button onclick="systemAction('Power diverted to engines.')">Divert Power</button>
      <button onclick="systemAction('Long-range scan initiated.')">Scan Area</button>
      <button onclick="systemAction('Opening hailing frequencies.')">Open Hailing</button>
    </div>
  </div>
</div>
<div id="graduation">
  <div class="certificate">
    <div class="cert-inner">
      <div class="cert-title">Starfleet Academy</div>
      <div class="cert-subtitle">Certificate of Completion</div>
      <div class="cert-name" id="certName"></div>
      <div class="cert-line"></div>
      <div class="cert-text" id="certText"></div>
      <div class="cert-assign" id="certAssign"></div>
      <div class="cert-sigs">
        <div class="sig"><div class="sig-name">C. Pike</div><div class="sig-title">Fleet Captain</div></div>
        <div class="sig"><div class="sig-name">J. Kirk</div><div class="sig-title">Command Instructor</div></div>
        <div class="sig"><div class="sig-name">Spock</div><div class="sig-title">Academy Dean</div></div>
      </div>
      <div class="cert-buttons">
        <button id="btnDownloadCert">Download Certificate</button>
        <button id="btnCloseCert">Close</button>
      </div>
    </div>
  </div>
</div>
<script>
const DATA_URL = "Kobayashi_Maru.json";
const messageBox = document.getElementById('message');
const buttonsBox = document.getElementById('buttons');
const stars = document.getElementById('stars');
const tactical = document.getElementById('tactical');
const grad = document.getElementById('graduation');
const certName = document.getElementById('certName');
const certText = document.getElementById('certText');
const certAssign = document.getElementById('certAssign');
const btnDownloadCert = document.getElementById('btnDownloadCert');
const btnCloseCert = document.getElementById('btnCloseCert');
let scenes = {};
let currentAlert = 'green';
let contactsPresent = false;
const metrics = { aggression: 0, caution: 0, empathy: 0, diplomacy: 0, protocol: 0 };
const debriefs = {
  rescue: "Cadet chose to cross the Neutral Zone and mount a rescue of the Kobayashi Maru.",
  treaty: "Cadet declined to violate the Neutral Zone, prioritizing Federation treaties.",
  partial: "Cadet initiated a rescue operation with partial success and tactical withdrawal.",
  negotiation: "Cadet opened communications with Klingon forces, seeking a diplomatic resolution.",
  withdrawal: "Cadet assessed the tactical imbalance and elected to withdraw from engagement."
};
const departments = ["Command", "Science", "Engineering", "Medical", "Security", "Tactical"];
const ships = [
  { name: "Enterprise", reg: "NCC-1701-E" },
  { name: "Voyager", reg: "NCC-74656" },
  { name: "Defiant", reg: "NX-74205" },
  { name: "Excelsior", reg: "NCC-2000" },
  { name: "Titan", reg: "NCC-80102" }
];
for (let i = 0; i < 220; i++) {
  const s = document.createElement('div');
  s.className = 'star';
  s.style.top = Math.random() * 100 + '%';
  s.style.left = Math.random() * 100 + '%';
  s.style.animationDelay = (Math.random() * 5) + 's';
  s.style.opacity = Math.random();
  stars.appendChild(s);
}
function toMap(list) {
  const m = {};
  list.forEach(o => { if (o && o.id) m[o.id] = o; });
  return m;
}
function typeText(txt, done) {
  messageBox.textContent = "";
  let i = 0;
  (function step() {
    if (i < txt.length) {
      messageBox.textContent += txt.charAt(i++);
      setTimeout(step, 22);
    } else if (done) done();
  })();
}
function detectAlertFromText(t) {
  const text = t.toLowerCase();
  if (/red alert/.test(text)) return 'red';
  if (/yellow alert/.test(text)) return 'yellow';
  if (/green alert/.test(text)) return 'green';
  return null;
}
function detectContactsFromText(t) {
  const text = t.toLowerCase();
  if (/klingon|enemy ships|warp signatures inbound|decloak/.test(text)) return true;
  return false;
}
function setAlert(level) {
  const body = document.body;
  if (!level || level === currentAlert) return;
  currentAlert = level;
  body.classList.remove('alert-green', 'alert-yellow', 'alert-red');
  body.classList.add(`alert-${level}`);
  systemAction(`Alert level set to ${level.toUpperCase()}.`);
}
function systemAction(text) { typeText(text, null); }
function recordMetrics(choice) {
  const text = choice.toLowerCase();
  if (/attack|fire|engage|rescue/.test(text)) metrics.aggression++;
  if (/retreat|withdraw|stand down/.test(text)) metrics.caution++;
  if (/hail|communicate|negotiate/.test(text)) metrics.diplomacy++;
  if (/regulation|order|protocol/.test(text)) metrics.protocol++;
  if (/rescue|save|help/.test(text)) metrics.empathy++;
}
function determineDebrief() {
  const { aggression, caution, empathy, diplomacy, protocol } = metrics;
  if (diplomacy > aggression && diplomacy > caution) return debriefs.negotiation;
  if (aggression > empathy && aggression > caution) return debriefs.rescue;
  if (empathy > aggression && empathy >= diplomacy) return debriefs.partial;
  if (protocol > empathy && protocol >= aggression) return debriefs.treaty;
  return debriefs.withdrawal;
}
function showGraduation() {
  const dept = departments[Math.floor(Math.random() * departments.length)];
  const ship = ships[Math.floor(Math.random() * ships.length)];
  const params = new URLSearchParams(window.location.search);
  const cadet = params.get("name") || "Unnamed Cadet";
  const species = params.get("species") || "";
  document.getElementById("hud").style.display = "none";
  certName.textContent = cadet;
  certText.textContent =
    "Having demonstrated proficiency in Starfleet Academy’s core disciplines and upheld the principles of the United Federation of Planets, the cadet is hereby recognized for successful completion of the Academy course of study.";
  certAssign.textContent = `Assignment: ${dept} Division, USS ${ship.name}, ${ship.reg}`;
  grad.style.display = "flex";
  btnDownloadCert.onclick = () => window.print();
  btnCloseCert.onclick = () => {
    grad.style.display = "none";
    document.getElementById("hud").style.display = "flex";
  };
}
function showScene(id) {
  const sc = scenes[id];
  if (!sc) {
    setAlert('red');
    messageBox.textContent = `Scene '${id}' not found.`;
    buttonsBox.innerHTML = "";
    return;
  }
  const inferred = detectAlertFromText(sc.text || "");
  if (inferred) setAlert(inferred);
  if (detectContactsFromText(sc.text || "")) contactsPresent = true;
  buttonsBox.innerHTML = "";
  typeText(sc.text || "", () => {
    (sc.options || []).forEach(o => {
      const b = document.createElement('button');
      b.textContent = o.label;
      b.onclick = () => {
        recordMetrics(o.label);
        if (o.label === "End Simulation") {
          showGraduation();
        } else {
          showScene(o.next);
        }
      };
      buttonsBox.appendChild(b);
    });
    if (sc.id.startsWith("end")) {
      const d = determineDebrief();
      buttonsBox.innerHTML = "";
      const b1 = document.createElement("button");
      b1.textContent = "View Starfleet Debrief";
      b1.onclick = () => {
        typeText(d, () => {
          buttonsBox.innerHTML = "";
          const endBtn = document.createElement("button");
          endBtn.textContent = "End Simulation";
          endBtn.onclick = showGraduation;
          buttonsBox.appendChild(endBtn);
        });
      };
      buttonsBox.appendChild(b1);
    }
  });
}
function spawnBlip() {
  if (!contactsPresent) return;
  const angle = Math.random() * 2 * Math.PI;
  const radius = 80;
  const b = document.createElement('div');
  b.className = 'blip';
  b.style.top = 50 + radius * Math.sin(angle) + '%';
  b.style.left = 50 + radius * Math.cos(angle) + '%';
  tactical.appendChild(b);
  setTimeout(() => {
    b.style.top = '50%';
    b.style.left = '50%';
    b.style.opacity = 1;
  }, 50);
  setTimeout(() => {
    if (b.parentNode === tactical) tactical.removeChild(b);
  }, 9000);
}
setInterval(spawnBlip, 3000);
async function init() {
  try {
    messageBox.textContent = "Loading mission data...";
    const res = await fetch(DATA_URL, { cache: 'no-store' });
    const data = await res.json();
    scenes = toMap(Array.isArray(data) ? data : (data.scenes || []));
    if (!scenes.start) throw new Error('Missing start');
    showScene('start');
  } catch (e) {
    setAlert('red');
    messageBox.textContent = "Error loading mission data.";
    buttonsBox.innerHTML = "";
  }
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
