<script>
document.addEventListener("DOMContentLoaded", () => {
  const departments = ["Command", "Diplomacy", "Engineering", "Security", "Science", "Medical"];
  const trainingFiles = Object.fromEntries(departments.map(d => [d, `https://raw.githubusercontent.com/BigBird7827/Starfleet_Academy/main/${d}%20Training.json`]));
  const labFiles = Object.fromEntries(departments.map(d => [d, `https://raw.githubusercontent.com/BigBird7827/Starfleet_Academy/main/${d}%20Lab.json`]));
  const examFiles = Object.fromEntries(departments.map(d => [d, `https://raw.githubusercontent.com/BigBird7827/Starfleet_Academy/main/${d}%20Exam.json`]));
  const progress = { labs: {}, exams: {} };

  const homeworlds = {
    "Human": "Earth","Vulcan": "Vulcan","Andorian": "Andoria","Aenar": "Andoria","Tellarite": "Tellar Prime",
    "Bajoran": "Bajor","Betazoid": "Betazed","Bolian": "Bolarus IX","Trill": "Trill","Klingon": "Qo'noS",
    "Ferengi": "Ferenginar","Denobulan": "Denobula","Orion": "Orion","Caitian": "Cait","Benzite": "Benzar"
  };

  let cadetName = "", species = "";
  const examBtn = document.getElementById("examBtn");
  const finalExamBtn = document.getElementById("finalExamBtn");

  function checkProgress() {
    const allLabsDone = departments.every(d => progress.labs[d]);
    const allExamsDone = departments.every(d => progress.exams[d]);
    if (allLabsDone) examBtn.disabled = false;
    if (allLabsDone && allExamsDone) {
      finalExamBtn.disabled = false;
      finalExamBtn.textContent = "Kobayashi Maru - Available";
    }
  }

  document.getElementById("loginBtn").addEventListener("click", () => {
    cadetName = document.getElementById("cadetName").value.trim();
    species = document.getElementById("species").value;
    if (!cadetName || !species) return alert("Enter name and species first.");
    const msg = document.getElementById("accessMessage");
    msg.textContent = `Access Link Established — Welcome, Cadet ${cadetName} of ${homeworlds[species]}.`;
    msg.classList.add("active");
    setTimeout(() => {
      document.getElementById("loginScreen").style.display = "none";
      document.getElementById("mainWelcome").textContent = `Welcome, Cadet ${cadetName} of ${homeworlds[species]}.`;
      document.getElementById("mainScreen").style.display = "block";
    }, 4000);
  });

  document.getElementById("trainingBtn").onclick = () => openOrientation("training");
  document.getElementById("labBtn").onclick = () => openOrientation("lab");
  document.getElementById("examBtn").onclick = () => openOrientation("exam");

  function openOrientation(mode) {
    document.getElementById("mainScreen").style.display = "none";
    const title = document.getElementById("orientationTitle");
    title.textContent = mode === "lab" ? "Select Lab Department" : mode === "exam" ? "Select Exam Department" : "Select Study Department";
    const btnBox = document.getElementById("moduleButtons");
    btnBox.innerHTML = "";
    departments.forEach(dept => {
      const b = document.createElement("button");
      b.textContent = dept;
      b.onclick = () => { mode === "training" ? loadTraining(dept) : mode === "lab" ? loadLab(dept) : loadExam(dept); };
      btnBox.appendChild(b);
    });
    document.getElementById("orientationPage").style.display = "block";
  }

  document.getElementById("returnMain").onclick = () => {
    document.getElementById("orientationPage").style.display = "none";
    document.getElementById("mainScreen").style.display = "block";
    checkProgress();
  };
  document.getElementById("returnOrientationTrain").onclick = () => {
    document.getElementById("trainingPage").style.display = "none";
    document.getElementById("orientationPage").style.display = "block";
  };
  document.getElementById("returnOrientationLab").onclick = () => {
    document.getElementById("labPage").style.display = "none";
    document.getElementById("orientationPage").style.display = "block";
    checkProgress();
  };
  document.getElementById("returnOrientationExam").onclick = () => {
    document.getElementById("examPage").style.display = "none";
    document.getElementById("orientationPage").style.display = "block";
    checkProgress();
  };

  async function loadTraining(dept) {
    document.getElementById("orientationPage").style.display = "none";
    document.getElementById("trainingPage").style.display = "block";
    document.getElementById("trainingDeptTitle").textContent = `${dept} Study`;
    document.getElementById("trainingCadetInfo").textContent = `Cadet ${cadetName} of ${homeworlds[species]}`;
    const content = document.getElementById("trainingContent");
    content.innerHTML = "<p>Loading...</p>";
    const res = await fetch(trainingFiles[dept]);
    const data = await res.json();
    content.innerHTML = "";
    data.study?.forEach(item => {
      const section = document.createElement("div");
      section.className = "training-section";
      const header = document.createElement("div");
      header.className = "training-header-bar";
      header.textContent = `${dept.toUpperCase()} DIVISION`;
      section.appendChild(header);
      const scenario = document.createElement("h3");
      scenario.textContent = item.scenario;
      section.appendChild(scenario);
      const summary = document.createElement("p");
      summary.textContent = item.summary;
      section.appendChild(summary);
      const answersDiv = document.createElement("div");
      answersDiv.className = "training-answers";
      item.answers.forEach((ans, i) => {
        const p = document.createElement("p");
        const strong = document.createElement("strong");
        strong.style.color = i === 0 ? "green" : i === 1 ? "teal" : "slategray";
        strong.textContent = ans.text;
        const span = document.createElement("span");
        span.textContent = ans.details;
        p.appendChild(strong);
        p.appendChild(span);
        answersDiv.appendChild(p);
      });
      section.appendChild(answersDiv);
      content.appendChild(section);
    });
  }

  async function loadLab(dept) {
    document.getElementById("orientationPage").style.display = "none";
    document.getElementById("labPage").style.display = "block";
    document.getElementById("labDeptTitle").textContent = `${dept} Lab`;
    document.getElementById("labCadetInfo").textContent = `Cadet ${cadetName} of ${homeworlds[species]}`;
    const content = document.getElementById("labContent");
    content.innerHTML = "<p>Loading...</p>";
    const res = await fetch(labFiles[dept]);
    const data = await res.json();
    const items = data.lab || [];
    let currentIndex = 0;
    showScenario(currentIndex);
    function showScenario(i) {
      const item = items[i];
      content.innerHTML = `<div class="training-section"><h3>${item.scenario}</h3><p>${item.summary || ""}</p></div>`;
      const answersDiv = document.createElement("div");
      answersDiv.className = "lab-answers";
      [...item.answers].sort(() => Math.random() - 0.5).forEach(ans => {
        const btn = document.createElement("button");
        btn.textContent = ans.text;
        btn.onclick = () => {
          answersDiv.querySelectorAll("button").forEach(b => b.disabled = true);
          const feedback = document.createElement("div");
          feedback.className = "feedback";
          feedback.innerHTML = ans.type === "best"
            ? `<span class='best-answer'>✅ Correct — Best Answer!</span><p>${ans.details}</p>`
            : `<span class='incorrect-answer'>❌ Incorrect</span><p>${item.answers.find(a => a.type==='best').text}</p>`;
          const next = document.createElement("button");
          next.textContent = i < items.length - 1 ? "Next Scenario ➡️" : "Return to Departments";
          next.onclick = () => {
            if (i < items.length - 1) showScenario(i + 1);
            else {
              progress.labs[dept] = true;
              document.getElementById("labPage").style.display = "none";
              document.getElementById("orientationPage").style.display = "block";
              checkProgress();
            }
          };
          feedback.appendChild(next);
          answersDiv.appendChild(feedback);
        };
        answersDiv.appendChild(btn);
      });
      content.appendChild(answersDiv);
    }
  }

  async function loadExam(dept) {
    document.getElementById("orientationPage").style.display = "none";
    document.getElementById("examPage").style.display = "block";
    document.getElementById("examDeptTitle").textContent = `${dept} Exam`;
    document.getElementById("examCadetInfo").textContent = `Cadet ${cadetName} of ${homeworlds[species]}`;
    const content = document.getElementById("examContent");
    content.innerHTML = "<p>Loading...</p>";
    const res = await fetch(examFiles[dept]);
    const data = await res.json();
    const items = data.exam || [];
    let currentIndex = 0;
    showQuestion(currentIndex);
    function showQuestion(i) {
      const item = items[i];
      content.innerHTML = `<div class="training-section"><h3>${item.scenario}</h3></div>`;
      const answersDiv = document.createElement("div");
      answersDiv.className = "exam-answers";
      [...item.answers].forEach(ans => {
        const btn = document.createElement("button");
        btn.textContent = ans.text;
        btn.onclick = () => {
          answersDiv.querySelectorAll("button").forEach(b => b.disabled = true);
          const feedback = document.createElement("div");
          feedback.className = "feedback";
          feedback.innerHTML = ans.type === "best"
            ? `<span class='best-answer'>✅ Correct — Best Answer!</span><p>${ans.details}</p>`
            : `<span class='incorrect-answer'>❌ Incorrect</span><p>${item.answers.find(a => a.type==='best').text}</p>`;
          const next = document.createElement("button");
          next.textContent = i < items.length - 1 ? "Next Question ➡️" : "Return to Departments";
          next.onclick = () => {
            if (i < items.length - 1) showQuestion(i + 1);
            else {
              progress.exams[dept] = true;
              document.getElementById("examPage").style.display = "none";
              document.getElementById("orientationPage").style.display = "block";
              checkProgress();
            }
          };
          feedback.appendChild(next);
          answersDiv.appendChild(feedback);
        };
        answersDiv.appendChild(btn);
      });
      content.appendChild(answersDiv);
    }
  }

  finalExamBtn.disabled = false;
  finalExamBtn.textContent = "Kobayashi Maru - Engage";

  finalExamBtn.onclick = () => {
    window.open("https://bigbird7827.github.io/Starfleet_Academy/Final_exam/Final_Exam.html", "_blank");
  };
});
</script>
